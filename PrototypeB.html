<!DOCTYPE html>
<html lang="en">

<head>
    <title>UBC Degree Planner</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins">
    <link rel="stylesheet" href="PrototypeB.css">
</head>

<body>

    <!-- Sidebar/menu -->
    <nav class="w3-sidebar w3-red w3-collapse w3-top w3-large w3-padding"
        style="z-index:3;width:300px;font-weight:bold;" id="mySidebar"><br>
        <a href="javascript:void(0)" onclick="w3_close()" class="w3-button w3-hide-large w3-display-topleft"
            style="width:100%;font-size:22px">Close Menu</a>
        <div class="w3-container">
            <h3 class="w3-padding-64"><b>UBC Engineering<br>Degree Planner</b>
                <img src="./assets/ubc_eng.png" style="max-height: 150px; margin: auto;">
            </h3>
        </div>
        <div class="w3-bar-block">
            <a href="#showcase" onclick="w3_close()" class="w3-bar-item w3-button w3-hover-white">Degree Planner</a>
            <a href="#services" onclick="w3_close()" class="w3-bar-item w3-button w3-hover-white">Students Like Me</a>
            <a href="#designers" onclick="w3_close()" class="w3-bar-item w3-button w3-hover-white">Help</a>
        </div>
    </nav>

    <!-- Top menu on small screens -->
    <header class="w3-container w3-top w3-hide-large w3-red w3-xlarge w3-padding">
        <a href="javascript:void(0)" class="w3-button w3-red w3-margin-right" onclick="w3_open()">‚ò∞</a>
        <span>Company Name</span>
    </header>

    <!-- Overlay effect when opening sidebar on small screens -->
    <div class="w3-overlay w3-hide-large" onclick="w3_close()" style="cursor:pointer" title="close side menu"
        id="myOverlay"></div>

    <!-- !PAGE CONTENT! -->
    <div class="w3-main" style="margin-left:340px;margin-right:40px">

        <!-- Header -->
        <div class="w3-container" style="margin-top:80px" id="showcase">
            <h1 class="w3-xxxlarge w3-text-red"><b>Degree Planner</b></h1>
            <hr style="width:50px;border:5px solid red" class="w3-round">
            <table id="">
                <tr>
                    <th>Course Type</th>
                    <th>Credits Completed</th>
                    <th>Credits Missing</th>
                </tr>
                <tr>
                    <td>First Year</td>
                    <td class="popup" id="firstYear" onclick="onClickCompletedCourses(this.id);">25
                        <span class="popuptext" id="firstYearPopup">
                            APSC 100 <br>
                            APSC 101 <br>
                            APSC 160 <br>
                            MATH 108 <br>
                            MATH 158 <br>
                        </span>
                    </td>
                    <td onclick=" onClickMissingCourses();">-
                        <span class="popuptext" id="firstYearMissing">
                            None
                        </span>
                    </td>
                </tr>
                <tr>
                    <td>Second Year</td>
                    <td class="popup" id="secondYear" onclick="onClickCompletedCourses(this.id);">13
                        <span class="popuptext" id="secondYearPopup">
                            CPEN 211 <br>
                            CPEN 261 <br>
                            ELEC 201 <br>
                            CPEN 291 <br>
                        </span>
                    </td>
                    <td onclick="onClickDud();">10</td>
                </tr>
                <tr>
                    <td>Third Year</td>
                    <td onclick="onClickDud();">23</td>
                    <td onclick="onClickDud();">3</td>
                </tr>
                <tr>
                    <td>Fourth Year</td>
                    <td onclick="onClickDud();">16</td>
                    <td onclick="onClickDud();">-</td>
                </tr>
                <tr>
                    <td>Electives</td>
                    <td onclick="onClickDud();">15</td>
                    <td onclick="onClickDud();">10</td>
                </tr>
            </table>
        </div>

        <!-- Services -->
        <div class="w3-container" id="services" style="margin-top:75px">
            <h1 class="w3-xxxlarge w3-text-red"><b>Students Like Me</b></h1>
            <hr style="width:50px;border:5px solid red" class="w3-round">
            <p>We found several students and graduates just like you! Click their profile to see their degree path.</p>
            <table>
                <tr></tr>
                <tr>
                    <td class="students">
                        <img src="./assets/female.jpg" onclick="onClickDud();">
                        <p>
                            <b>5-Year CPEN BASc Engineering Degree w/ Co-op</b><br>
                            Data Scientist @ Amazon
                        </p>
                    </td>
                    <td class="students">
                        <img src="./assets/male.jpg" onclick="onClickDud();">
                        <p>
                            <b>4-Year ELEC BASc Engineering Degree</b><br>
                            Software Developer @ Google
                        </p>
                    </td>
                    <td class="students">
                        <img src="./assets/female.jpg" onclick="onClickDud();">
                        <p>
                            <b>6-Year ELEC MASc Engineering Degree</b><br>
                            Process Engineer @ BC-Hydro
                        </p>
                    </td>
                </tr>
            </table>
        </div>

        <!-- Designers -->
        <div class="w3-container" id="designers" style="margin-top:75px;">
            <h1 class="w3-xxxlarge w3-text-red"><b>Help</b></h1>
            <hr style="width:50px;border:5px solid red" class="w3-round">
            <p>Submit a contact form to your advisor or chat with our state of the art EZbot to answer any APSC degree
                planning needs.</p>
            <p>
            <form onsubmit="formSubmit();">
                <div class="w3-section">
                    <label>Advisor</label><br>
                    <select name="advisor" id="advisor">
                        <option value="CPEN">CPEN</option>
                        <option value="ELEC">ELEC</option>
                        <option value="MECH">MECH</option>
                        <option value="CHBE">CHBE</option>
                    </select>
                </div>
                <div class="w3-section">
                    <label>Name</label>
                    <input class="w3-input w3-border" type="text" name="Name" required>
                </div>
                <div class="w3-section">
                    <label>Email</label>
                    <input class="w3-input w3-border" type="text" name="Email" required>
                </div>
                <div class="w3-section">
                    <label>Message</label>
                    <input class="w3-input w3-border" type="text" name="Message" required>
                </div>
                <button type="submit" class="w3-button w3-block w3-padding-large w3-red w3-margin-bottom">Send
                    Message</button>
            </form>

            <div id="container" class="container" style="display: none;">
                <img src="https://cdn.pixabay.com/photo/2020/01/02/16/38/chatbot-4736275_960_720.png" height="400vh"
                    alt="Chatbot clipart">
                <div id="chat" class="chat">
                    <div id="messages" class="messages"></div>
                    <input id="input" type="text" placeholder="Write something..." autocomplete="off"
                        autofocus="true" />
                </div>
            </div>

            <div class="chatbot chatbot--closed">
                <div class="chatbot__header">
                    <p><strong>Got a question?</strong> <span class="u-text-highlight">Ask EZbot</span></p>
                    <svg class="chatbot__close-button icon-speech" viewBox="0 0 32 32">
                        <use xlink:href="#icon-speech" />
                    </svg>
                    <svg class="chatbot__close-button icon-close" viewBox="0 0 32 32">
                        <use xlink:href="#icon-close" />
                    </svg>
                </div>
                <div class="chatbot__message-window">
                    <ul class="chatbot__messages">
                        <li class="is-ai animation">
                            <div class="is-ai__profile-picture">
                                <img src="./assets/g.svg" style="height: 60px; width: 60px;" />
                            </div>
                            <span class="chatbot__arrow chatbot__arrow--left"></span>
                            <p class='chatbot__message'>Hi there üñê. I‚Äôm EZbot, your virtual assistant. I'm here to help
                                with your APSC degree related enquiries.</p>
                        </li>
                        <!-- Answer and response added here -->
                    </ul>
                </div>
                <div class="chatbot__entry chatbot--closed">
                    <input type="text" class="chatbot__input" placeholder="Write a message..." />
                    <svg class="chatbot__submit" viewBox="0 0 32 32">
                        <use xlink:href="#icon-send" />
                    </svg>
                </div>
            </div>
            </p>

        </div>

        <!-- End page content -->
    </div>

    <!-- W3.CSS Container -->
    <div class="w3-light-grey w3-container w3-padding-32" style="margin-top:75px;padding-right:58px">
        <p class="w3-right">Powered by <a href="https://www.w3schools.com/w3css/default.asp" title="W3.CSS"
                target="_blank" class="w3-hover-opacity">w3.css</a></p>
    </div>

    <script>
        // Script to open and close sidebar
        function w3_open() {
            document.getElementById("mySidebar").style.display = "block";
            document.getElementById("myOverlay").style.display = "block";
        }

        function w3_close() {
            document.getElementById("mySidebar").style.display = "none";
            document.getElementById("myOverlay").style.display = "none";
        }
        function formSubmit() {
            window.alert("Form submitted");
        }

        function onClickDud() {
            var popup = document.getElementById("myPopup");
            popup.classList.toggle("show");
        }

        function onClickCompletedCourses(id) {
            var popup = document.getElementById(`${id}Popup`);
            console.log(popup.classList);
            popup.classList.toggle("show");
        }

        function onClickMissingCourses() {
            var popup = document.getElementById("firstYearMissing");
            popup.toggle("show");
        }
        // Chatbot code

        const utterances = [
            ["how are you", "how is life", "how are things"],        //0
            ["hi", "hey", "hello", "good morning", "good afternoon"],      //1
            ["what are you doing", "what is going on", "what is up"],      //2
            ["how old are you"],					//3
            ["who are you", "are you human", "are you bot", "are you human or bot"]  //4
        ]
            ;

        // Possible responses corresponding to triggers

        const answers = [
            [
                "Fine... how are you?",
                "Pretty well, how are you?",
                "Fantastic, how are you?"
            ],                                                                                  	//0
            [
                "Hello!", "Hi!", "Hey!", "Hi there!", "Howdy"
            ],						//1
            [
                "Nothing much",
                "About to go to sleep",
                "Can you guess?",
                "I don't know actually"
            ],						//2
            ["I am infinite"],					//3
            ["I am just a bot", "I am a bot. What are you?"],	//4

        ];

        // For any other user input

        const alternatives = [
            "Go on...",
            "Try again",
        ];
        const inputField = document.getElementById("input");
        inputField.addEventListener("keydown", (e) => {
            if (e.code === "Enter") {
                let input = inputField.value;
                inputField.value = "";
                output(input);
            }
        });

        function output(input) {
            let product;
            let text = input.toLowerCase().replace(/[^\w\s\d]/gi, "");
            text = text
                .replace(/ a /g, " ")
                .replace(/whats/g, "what is")
                .replace(/please /g, "")
                .replace(/ please/g, "")
                .replace(/r u/g, "are you");

            if (compare(utterances, answers, text)) {
                // Search for exact match in triggers
                product = compare(utterances, answers, text);
            }
            else {
                product = alternatives[Math.floor(Math.random() * alternatives.length)];
            }

            addChatEntry(input, product);
        }

        function compare(utterancesArray, answersArray, string) {
            let reply;
            let replyFound = false;
            for (let x = 0; x < utterancesArray.length; x++) {
                for (let y = 0; y < utterancesArray[x].length; y++) {
                    if (utterancesArray[x][y] === string) {
                        let replies = answersArray[x];
                        reply = replies[Math.floor(Math.random() * replies.length)];
                        replyFound = true;
                        break;
                    }
                }
                if (replyFound) {
                    break;
                }
            }
            return reply;
        }

        function addChatEntry(input, product) {
            const messagesContainer = document.getElementById("messages");
            let userDiv = document.createElement("div");
            userDiv.id = "user";
            userDiv.className = "user response";
            userDiv.innerHTML = `<span>${input}</span>`;
            messagesContainer.appendChild(userDiv);

            let botDiv = document.createElement("div");
            let botText = document.createElement("span");
            botDiv.id = "bot";
            botDiv.className = "bot response";
            botText.innerText = "Typing...";
            botDiv.appendChild(botText);
            messagesContainer.appendChild(botDiv);

            messagesContainer.scrollTop =
                messagesContainer.scrollHeight - messagesContainer.clientHeight;

            setTimeout(() => {
                botText.innerText = `${product}`;
            }, 2000);
        }

        const accessToken = '3796899bd37c423bad3a21a25277bce0'
        const baseUrl = 'https://api.api.ai/api/query?v=2015091001'
        const sessionId = '20150910';
        const loader = `<span class='loader'><span class='loader__dot'></span><span class='loader__dot'></span><span class='loader__dot'></span></span>`
        const errorMessage = 'My apologies, I\'m not available at the moment, however, feel free to call our support team directly 0123456789.'
        const urlPattern = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim
        const $document = document
        const $chatbot = $document.querySelector('.chatbot')
        const $chatbotMessageWindow = $document.querySelector('.chatbot__message-window')
        const $chatbotHeader = $document.querySelector('.chatbot__header')
        const $chatbotMessages = $document.querySelector('.chatbot__messages')
        const $chatbotInput = $document.querySelector('.chatbot__input')
        const $chatbotSubmit = $document.querySelector('.chatbot__submit')

        const botLoadingDelay = 1000
        const botReplyDelay = 2000

        document.addEventListener('keypress', event => {
            if (event.which == 13) validateMessage()
        }, false)

        $chatbotHeader.addEventListener('click', () => {
            toggle($chatbot, 'chatbot--closed')
            $chatbotInput.focus()
        }, false)

        $chatbotSubmit.addEventListener('click', () => {
            validateMessage()
        }, false)

        const toggle = (element, klass) => {
            const classes = element.className.match(/\S+/g) || [],
                index = classes.indexOf(klass)
            index >= 0 ? classes.splice(index, 1) : classes.push(klass)
            element.className = classes.join(' ')
        }

        const userMessage = content => {
            $chatbotMessages.innerHTML += `<li class='is-user animation'>
      <p class='chatbot__message' style="color: #ffffff">
        ${content}
      </p>
      <span class='chatbot__arrow chatbot__arrow--right'></span>
    </li>`
        }

        const aiMessage = (content, isLoading = false, delay = 0) => {
            setTimeout(() => {
                removeLoader()
                $chatbotMessages.innerHTML += `<li 
      class='is-ai animation' 
      id='${isLoading ? "is-loading" : ""}'>
        <div class="is-ai__profile-picture">
            <img src="./assets/g.svg" style="height: 60px; width: 60px;"/>
        </div>
        <span class='chatbot__arrow chatbot__arrow--left'></span>
        <div class='chatbot__message'>${content}</div>
      </li>`
                scrollDown()
            }, delay)
        }

        const removeLoader = () => {
            let loadingElem = document.getElementById('is-loading')
            if (loadingElem) $chatbotMessages.removeChild(loadingElem)
        }

        const escapeScript = unsafe => {
            const safeString = unsafe
                .replace(/</g, ' ')
                .replace(/>/g, ' ')
                .replace(/&/g, ' ')
                .replace(/"/g, ' ')
                .replace(/\\/, ' ')
                .replace(/\s+/g, ' ')
            return safeString.trim()
        }

        const linkify = inputText => {
            return inputText.replace(urlPattern, `<a href='$1' target='_blank'>$1</a>`)
        }

        const validateMessage = () => {
            const text = $chatbotInput.value
            const safeText = text ? escapeScript(text) : ''
            if (safeText.length && safeText !== ' ') {
                resetInputField()
                userMessage(safeText)
                send(safeText)
            }
            scrollDown()
            return
        }

        const multiChoiceAnswer = text => {
            const decodedText = text.replace(/zzz/g, "'")
            userMessage(decodedText)
            send(decodedText)
            scrollDown()
            return
        }

        const processResponse = val => {
            if (val && val.fulfillment) {
                let output = ''
                let messagesLength = val.fulfillment.messages.length

                for (let i = 0; i < messagesLength; i++) {
                    let message = val.fulfillment.messages[i]
                    let type = message.type

                    switch (type) {
                        // 0 fulfillment is text
                        case 0:
                            let parsedText = linkify(message.speech)
                            output += `<p>${parsedText}</p>`
                            break

                        // 1 fulfillment is card
                        case 1:
                            let imageUrl = message.imageUrl
                            let imageTitle = message.title
                            let imageSubtitle = message.subtitle
                            let button = message.buttons[0]

                            if (!imageUrl && !button && !imageTitle && !imageSubtitle) break

                            output += `
            <a class='card' href='${button.postback}' target='_blank'>
              <img src='${imageUrl}' alt='${imageTitle}' />
            <div class='card-content'>
              <h4 class='card-title'>${imageTitle}</h4>
              <p class='card-title'>${imageSubtitle}</p>
              <span class='card-button'>${button.text}</span>
            </div>
            </a>
          `
                            break

                        // 2 fulfillment is a quick reply with multi-choice buttons
                        case 2:
                            let title = message.title
                            let replies = message.replies
                            let repliesLength = replies.length
                            output += `<p>${title}</p>`

                            for (let i = 0; i < repliesLength; i++) {
                                let reply = replies[i]
                                let encodedText = reply.replace(/'/g, 'zzz')
                                output += `<button onclick='multiChoiceAnswer("${encodedText}")'>${reply}</button>`
                            }
                            break
                    }
                }

                removeLoader()
                return output
            }

            removeLoader()
            return `<p>${errorMessage}</p>`
        }

        const setResponse = (val, delay = 0) => {
            setTimeout(() => {
                aiMessage(processResponse(val))
            }, delay)
        }

        const resetInputField = () => {
            $chatbotInput.value = ''
        }

        const scrollDown = () => {
            const distanceToScroll =
                $chatbotMessageWindow.scrollHeight -
                ($chatbotMessages.lastChild.offsetHeight + 60)
            $chatbotMessageWindow.scrollTop = distanceToScroll
            return false
        }

        const send = (text = '') => {
            fetch(`${baseUrl}&query=${text}&lang=en&sessionId=${sessionId}`, {
                method: 'GET',
                dataType: 'json',
                headers: {
                    Authorization: 'Bearer ' + accessToken,
                    'Content-Type': 'application/json; charset=utf-8'
                }
            })
                .then(response => response.json())
                .then(res => {
                    if (res.status < 200 || res.status >= 300) {
                        let error = new Error(res.statusText)
                        throw error
                    }
                    return res
                })
                .then(res => {
                    setResponse(res.result, botLoadingDelay + botReplyDelay)
                })
                .catch(error => {
                    setResponse(errorMessage, botLoadingDelay + botReplyDelay)
                    resetInputField()
                    console.log(error)
                })

            aiMessage(loader, true, botLoadingDelay)
        }
        var slideIndex = 1;
        showDivs(slideIndex);

        function plusDivs(n) {
            showDivs(slideIndex += n);
        }

        function showDivs(n) {
            var i;
            var x = document.getElementsByClassName("mySlides");
            if (n > x.length) { slideIndex = 1 }
            if (n < 1) { slideIndex = x.length }
            for (i = 0; i < x.length; i++) {
                x[i].style.display = "none";
            }
            x[slideIndex - 1].style.display = "block";
        }
    </script>

</body>

</html>